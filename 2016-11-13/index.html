<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>java 基础 ----基本数据结构 - 日拱一卒,功不唐捐</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="基本数据类型
字符型(char)

java 采用 unicode 编码， 使用 2 个字节表示一个字符，所以java中的一个字符是 2 个字节c 语言使用的是 ASCII 编码，一个 char 占用 1 个字节。
由于是无符号的，且 2 个字节 32 位长度，那么其访问是 0 到 65535 。

布尔类型: boolean

数值类型: 有符号数值类型，最高位表示符号位  byte : 1 字">
<meta property="og:type" content="article">
<meta property="og:title" content="java 基础 ----基本数据结构">
<meta property="og:url" content="http://yangsui.me/2016-11-13/index.html">
<meta property="og:site_name" content="日拱一卒,功不唐捐">
<meta property="og:description" content="基本数据类型
字符型(char)

java 采用 unicode 编码， 使用 2 个字节表示一个字符，所以java中的一个字符是 2 个字节c 语言使用的是 ASCII 编码，一个 char 占用 1 个字节。
由于是无符号的，且 2 个字节 32 位长度，那么其访问是 0 到 65535 。

布尔类型: boolean

数值类型: 有符号数值类型，最高位表示符号位  byte : 1 字">
<meta property="og:image" content="http://7xlqpv.com1.z0.glb.clouddn.com/signed-byte-to-int.jpg">
<meta property="og:image" content="http://7xlqpv.com1.z0.glb.clouddn.com/14797179520991.jpg">
<meta property="og:updated_time" content="2016-11-22T08:26:13.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java 基础 ----基本数据结构">
<meta name="twitter:description" content="基本数据类型
字符型(char)

java 采用 unicode 编码， 使用 2 个字节表示一个字符，所以java中的一个字符是 2 个字节c 语言使用的是 ASCII 编码，一个 char 占用 1 个字节。
由于是无符号的，且 2 个字节 32 位长度，那么其访问是 0 到 65535 。

布尔类型: boolean

数值类型: 有符号数值类型，最高位表示符号位  byte : 1 字">
<meta name="twitter:image" content="http://7xlqpv.com1.z0.glb.clouddn.com/signed-byte-to-int.jpg">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">文档</a>
        
          <a class="main-nav-link" href="/categories">分类</a>
        
          <a class="main-nav-link" href="/tags">标签</a>
        
          <a class="main-nav-link" href="/about">联系我</a>
        
          <a class="main-nav-link" href="/atom.xml">Rss</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yangsui.me"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-2016-11-13" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      java 基础 ----基本数据结构
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016-11-13/" class="article-date">
  <time datetime="2016-11-20T06:06:00.000Z" itemprop="datePublished">2016-11-20</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h1><ul>
<li>字符型(char)</li>
</ul>
<p>java 采用 unicode 编码， 使用 2 个字节表示一个字符，所以java中的一个字符是 <code>2 个字节</code><br>c 语言使用的是 ASCII 编码，一个 char 占用 1 个字节。</p>
<p>由于是无符号的，且 2 个字节 32 位长度，那么其访问是 0 到 65535 。</p>
<ul>
<li><p>布尔类型: boolean</p>
</li>
<li><p>数值类型: 有符号数值类型，最高位表示符号位<br>  byte : 1 字节<br>  short : 2 字节<br>  int : 4 字节<br>  long : 8 字节<br>  float : 4 字节<br>  double : 8 字节</p>
</li>
</ul>
<a id="more"></a> 
<h1 id="基本数据类型操作"><a href="#基本数据类型操作" class="headerlink" title="基本数据类型操作"></a>基本数据类型操作</h1><ul>
<li><p>左移 &lt;&lt;</p>
<ul>
<li>丢弃最高位，0 补最低位</li>
<li>如果数据没有溢出，每左移动 1 位，数据相当于乘以 2 的 1 次方，移动 n 位 相当于乘以 2 的 n 次方。</li>
</ul>
</li>
<li><p>右移 &gt;&gt;</p>
<ul>
<li>符号位不变，左边补符号位</li>
</ul>
</li>
<li><p>按位与 &amp;</p>
<ul>
<li>只有 1 &amp; 1 = 1 其它等于 0</li>
</ul>
</li>
<li><p>按位或 |</p>
<ul>
<li>只有 0 | 0 = 0</li>
</ul>
</li>
<li><p>按位取反 ~</p>
<ul>
<li>各位 0 变 1 ， 1 变 0</li>
</ul>
</li>
<li><p>按位异或 ^</p>
<ul>
<li>先按位或，在按位取反</li>
<li>相同为 0 ， 不同为 1</li>
</ul>
</li>
</ul>
<h1 id="有符号类型转换为无符号类型"><a href="#有符号类型转换为无符号类型" class="headerlink" title="有符号类型转换为无符号类型"></a>有符号类型转换为无符号类型</h1><p>下面这幅图展示了一个 byte 类型的有符号整数，如 -5 转换为一个无符号整数的过程。</p>
<p>注意3点：</p>
<ul>
<li>位运算是针对整型，进行位运算的时候，除了 long 之外，其它类型会自动转换为整型。</li>
<li>负数在计算中以补码表示的</li>
<li>不同于 C，JAVA 中不存在无符号整数，都是有符号的</li>
</ul>
<p><img src="http://7xlqpv.com1.z0.glb.clouddn.com/signed-byte-to-int.jpg" alt="byte -5"></p>
<p>具体的代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//将 data 字节类型转换为 0 ~ 255 (0xFF 即 1 Byte)</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUnsignedByte</span><span class="params">(<span class="keyword">byte</span> data)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> data &amp; <span class="number">0xFF</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//将 data 字节类型转换为 0 ~ 65535 (0xFFFF 即 1 Word)</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUnsignedByte</span><span class="params">(<span class="keyword">short</span> data)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> data &amp; <span class="number">0xFFFF</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//将 data 字节类型转换为 0 ~ 4294967295 (0xFFFFFFFF 即 DWord)</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getUnsignedInt</span><span class="params">(<span class="keyword">int</span> data)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> data &amp; <span class="number">0xFFFFFFFF</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>JDK 是怎么实现的 ？ JDK 中有 <code>Byte.toUnsignedInt(byte x)</code> 方法，源代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Converts the argument to an &#123;<span class="doctag">@code</span> int&#125; by an unsigned</div><div class="line"> * conversion.  In an unsigned conversion to an &#123;<span class="doctag">@code</span> int&#125;, the</div><div class="line"> * high-order 24 bits of the &#123;<span class="doctag">@code</span> int&#125; are zero and the</div><div class="line"> * low-order 8 bits are equal to the bits of the &#123;<span class="doctag">@code</span> byte&#125; argument.</div><div class="line"> *</div><div class="line"> * Consequently, zero and positive &#123;<span class="doctag">@code</span> byte&#125; values are mapped</div><div class="line"> * to a numerically equal &#123;<span class="doctag">@code</span> int&#125; value and negative &#123;<span class="doctag">@code</span></div><div class="line"> * byte&#125; values are mapped to an &#123;<span class="doctag">@code</span> int&#125; value equal to the</div><div class="line"> * input plus 2&lt;sup&gt;8&lt;/sup&gt;.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span>  x the value to convert to an unsigned &#123;<span class="doctag">@code</span> int&#125;</div><div class="line"> * <span class="doctag">@return</span> the argument converted to &#123;<span class="doctag">@code</span> int&#125; by an unsigned</div><div class="line"> *         conversion</div><div class="line"> * <span class="doctag">@since</span> 1.8</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">toUnsignedInt</span><span class="params">(<span class="keyword">byte</span> x)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">int</span>) x) &amp; <span class="number">0xff</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的文档说得非常清楚</p>
<blockquote>
<p>将参数进行一个无符号 int 转换， 在这个转换中，一个 int 的整数，高 24 位为 0，低 8 位的值等于原有byte 参数的值。所以，如果 byte 类型参数的值是 0 或 正数，转换为数值上相等的一个 int 值；如果 byte 类型参数的值是负数，转换的结果等于 byte 的输入值加上 2 的 8 次方，即输入值加 256。</p>
</blockquote>
<p>所以，-5 转换为 int 后的值是  256 + (-5) = 251 </p>
<h1 id="网络协议中的报文运算"><a href="#网络协议中的报文运算" class="headerlink" title="网络协议中的报文运算"></a>网络协议中的报文运算</h1><ul>
<li><p>如一个 C 语言中无符号 byte 133，即 0x85 = 10000101，在 JAVA 中获取，直接输出会是个负数，要获取正确的输出，使用上面的<code>getUnsignedByte</code>方法。</p>
</li>
<li><p>假设某个字节的 8 位中的第 3 和第 4 位代表了某种意义，如何取出这几位?</p>
<p>假设这个字节的数据如下：<code>01011010</code> 其中第 3 和第 4 位分别是 <code>0 1</code>，构造这样一个数据，<code>00110000</code>，即保证 3 4为1，其它位和原始数据为 0 ，使用之前的数据和构造后的数据进行 <strong>与运算</strong>，得到 <code>00010000</code>，然后在右移 4 位就得到 3 4 位的值。</p>
<p>这个例子有两个重点：</p>
<ol>
<li><p>与运算，只有1 和 1 相与等于 1，其它都等于 0。所以这里我们只需要在 3  4 位构造值为 1 其它位构造值为 0 就可以了。</p>
</li>
<li><p>与运算结合位移运算</p>
</li>
</ol>
</li>
</ul>
<h1 id="JAVA-中的自动装箱"><a href="#JAVA-中的自动装箱" class="headerlink" title="JAVA 中的自动装箱"></a>JAVA 中的自动装箱</h1><p>声明 <code>Integer i = 100</code>， JAVA 编译器会做如下的语法编译 <code>Integer.valueOf(100)</code>，源代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns an &#123;<span class="doctag">@code</span> Integer&#125; instance representing the specified</div><div class="line"> * &#123;<span class="doctag">@code</span> int&#125; value.  If a new &#123;<span class="doctag">@code</span> Integer&#125; instance is not</div><div class="line"> * required, this method should generally be used in preference to</div><div class="line"> * the constructor &#123;<span class="doctag">@link</span> #Integer(int)&#125;, as this method is likely</div><div class="line"> * to yield significantly better space and time performance by</div><div class="line"> * caching frequently requested values.</div><div class="line"> *</div><div class="line"> * This method will always cache values in the range -128 to 127,</div><div class="line"> * inclusive, and may cache other values outside of this range.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span>  i an &#123;<span class="doctag">@code</span> int&#125; value.</div><div class="line"> * <span class="doctag">@return</span> an &#123;<span class="doctag">@code</span> Integer&#125; instance representing &#123;<span class="doctag">@code</span> i&#125;.</div><div class="line"> * <span class="doctag">@since</span>  1.5</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)</div><div class="line">        <span class="keyword">return</span> IntegerCache.cache[i + (-IntegerCache.low)];</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Integer(i);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>doc 上说得很明白，</p>
<blockquote>
<p>valueOf 方法会返回一个缓存值，范围是 -128 到 127 之间，包括两个端值即 -128 和 127。在指定了 JVM 参数(-XX:AutoBoxCacheMax )之后也可以缓存这个范围之外的值。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Cache to support the object identity semantics of autoboxing for values between</div><div class="line"> * -128 and 127 (inclusive) as required by JLS.</div><div class="line"> *</div><div class="line"> * The cache is initialized on first usage.  The size of the cache</div><div class="line"> * may be controlled by the &#123;<span class="doctag">@code</span> -XX:AutoBoxCacheMax=&lt;size&gt;&#125; option.</div><div class="line"> * During VM initialization, java.lang.Integer.IntegerCache.high property</div><div class="line"> * may be set and saved in the private system properties in the</div><div class="line"> * sun.misc.VM class.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerCache</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> low = -<span class="number">128</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> high;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Integer cache[];</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="comment">// high value may be configured by property</span></div><div class="line">        <span class="keyword">int</span> h = <span class="number">127</span>;</div><div class="line">        String integerCacheHighPropValue =</div><div class="line">            sun.misc.VM.getSavedProperty(<span class="string">"java.lang.Integer.IntegerCache.high"</span>);</div><div class="line">        <span class="keyword">if</span> (integerCacheHighPropValue != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">int</span> i = parseInt(integerCacheHighPropValue);</div><div class="line">                i = Math.max(i, <span class="number">127</span>);</div><div class="line">                <span class="comment">// Maximum array size is Integer.MAX_VALUE</span></div><div class="line">                h = Math.min(i, Integer.MAX_VALUE - (-low) -<span class="number">1</span>);</div><div class="line">            &#125; <span class="keyword">catch</span>( NumberFormatException nfe) &#123;</div><div class="line">                <span class="comment">// If the property cannot be parsed into an int, ignore it.</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        high = h;</div><div class="line"></div><div class="line">        cache = <span class="keyword">new</span> Integer[(high - low) + <span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> j = low;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; cache.length; k++)</div><div class="line">            cache[k] = <span class="keyword">new</span> Integer(j++);</div><div class="line"></div><div class="line">        <span class="comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span></div><div class="line">        <span class="keyword">assert</span> IntegerCache.high &gt;= <span class="number">127</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">IntegerCache</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="JAVA-的小数问题"><a href="#JAVA-的小数问题" class="headerlink" title="JAVA 的小数问题"></a>JAVA 的小数问题</h1><p>JAVA 中的小数的问题需要注意两个问题，精确度和范围</p>
<ul>
<li><p>因为使用二进制来精确表示十进制小数，如 0.1 是做不到，所以会涉及到一个精度的问题</p>
</li>
<li><p>如 long 类型的最大值在加上一个数，就会溢出了</p>
</li>
</ul>
<h1 id="JAVA-的大数值计算"><a href="#JAVA-的大数值计算" class="headerlink" title="JAVA 的大数值计算"></a>JAVA 的大数值计算</h1><ul>
<li><p>使用 <code>BigInteger</code> 和 <code>BigDecimal</code> 来表示大整数和大浮点数类，理论上能够表示无限大的数</p>
</li>
<li><p>BigInteger 和 BigDecimal 用于精确表示大整数和小数，常用于商业计算中</p>
</li>
<li><p>BigInteger 和 BigDecimal 都是不可变的，在每进行一次运算的时候，都会产生一个新的对象，因此他们不适合大量数学运算，应尽量使用 long float double 等基本类型做科学计算和工程计算</p>
</li>
<li><p>如果需要精确计算，用 String 构造 BigDecimal，避免用 double 构造，因为有些数字用 double 根本就无法精确表示，传给 BigDecimal 的构造方法就已经不精确了。</p>
</li>
<li><p>数值比较两个 BigDecimal 的时候要使用 <code>compareTo()</code>，而不是 <code>equals()</code>。equals 认为 0.1 和 0.1相等，0.1 和 0.10 不相等；compareTo 认为都是相等的。</p>
</li>
<li><p>有时候任意精度的小数运算仍然不能表示精确结果。 如 1 除以 9，所以在进行除法运算时，<code>BigDecimal</code> 可以显示控制舍入</p>
</li>
</ul>
<h1 id="CPU-Cache"><a href="#CPU-Cache" class="headerlink" title="CPU Cache"></a>CPU Cache</h1><p>计算机初期是 CPU 直接和主存进行交互，后来 CPU 的运算速度越来越快，导致主存完全跟不上。这个时候在 CPU 和主存之间添加了高速缓存。下图大致描述了各级缓存的关系。</p>
<p><img src="http://7xlqpv.com1.z0.glb.clouddn.com/14797179520991.jpg" alt="CPU Cache 存储结构图"></p>
<p>整个 Cache 被分成若干个组，每组包含若干 <code>Cache Line</code>，每个 Cache Line 中有 <strong>64</strong> 个字节来存储数据。所以总的 Cache 大小是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">total = 分组数量 * CacheLine数量 * 单个CacheLine大小</div><div class="line">``` </div><div class="line"></div><div class="line">贴一个我本机的 Cache 截图，几个术语如下</div><div class="line"></div><div class="line">- `number of sets` 代表有多少个分组</div><div class="line">- `ways of associativity` 翻译过来是组合方式，每个分组里面包含的 CacheLine 行数</div><div class="line">- `coherency line size` 单个 CacheLine 大小</div><div class="line"></div><div class="line">![-w409](/media/14797367807174.jpg)</div><div class="line"></div><div class="line">从图中可以看到我本机 CPU 的 L1 为 32KB，每个 Cache Line 大小为 64B，每组 8 个 CacheLine，按照上面的公式计算，那么分组的结果是：32 * 1024/8 * 64 = 64，所以我本机有 64 个高速缓存组。现代 CPU 会一次性读取一个 Cache Line 大小即 64B 的数据，即使我们的程序哪怕只请求一个 Bit 的数据。我们要很好的利用这点，写出 cache friendly 的程序来。</div><div class="line"></div><div class="line">在 C 和 JAVA 中数组在内存中是连续分配的，是面向行存储的，即如果要读取某一列的数据，那么要跨越多个数据。我们有如下的测试程序。</div><div class="line"></div><div class="line">```java</div><div class="line">public class Test &#123;</div><div class="line"></div><div class="line">    final int row = 1024 * 256;</div><div class="line">    final int col = 16 * 32;</div><div class="line">    int[][] matrix = new int[row][col];</div><div class="line">    Random r = new Random();</div><div class="line"></div><div class="line">    public Test() &#123;</div><div class="line">        for (int i = 0; i &lt; row; i++) &#123;</div><div class="line">            for (int j = 0; j &lt; col; j++) &#123;</div><div class="line">                matrix[i][j] = r.nextInt(100);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void row() &#123;</div><div class="line">        long sum = 0;</div><div class="line">        for (int i = 0; i &lt; row; i++) &#123;</div><div class="line">            for (int j = 0; j &lt; col; j++) &#123;</div><div class="line">                sum += matrix[i][j];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;add row:\t&quot; + sum);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void col() &#123;</div><div class="line">        long sum = 0;</div><div class="line">        for (int i = 0; i &lt; col; i++) &#123;</div><div class="line">            for (int j = 0; j &lt; row; j++) &#123;</div><div class="line">                sum += matrix[j][i];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;add col:\t&quot; + sum);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Test t = new Test();</div><div class="line"></div><div class="line">        final long start = System.currentTimeMillis();</div><div class="line">        t.row();</div><div class="line">        final long rowCost = System.currentTimeMillis() - start;</div><div class="line">        System.out.println(&quot;add by row time cost :\t&quot; + rowCost);</div><div class="line"></div><div class="line">        t.col();</div><div class="line">        final long colCost = System.currentTimeMillis() - start;</div><div class="line">        System.out.println(&quot;add by col time cost :\t&quot; + colCost);</div><div class="line"></div><div class="line">        System.out.println(&quot;performance ratio :\t&quot; + (colCost * 1.0) / rowCost);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我的 JDK 版本是 <code>1.8</code>，运行结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">add row:	<span class="number">6644125459</span></div><div class="line">add by row time cost :	<span class="number">127</span></div><div class="line">add col:	<span class="number">6644125459</span></div><div class="line">add by col time cost :	<span class="number">2394</span></div><div class="line">performance ratio :	<span class="number">18.8503937007874</span></div></pre></td></tr></table></figure>
<p>我们总共进行了 <code>134217728</code> 次运算，分别按照<strong>行</strong>和<strong>列</strong>的方式求和，发现按照列的方式求和比行的方式 <strong>慢18倍</strong> 多。我们来分析下原因。</p>
<p>matrix 是一个二维数组，我们知道 JAVA 数组是以一纬的方式存储的，看上去一个二维数组像这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>,<span class="number">0</span> | <span class="number">0</span>,<span class="number">1</span> | <span class="number">0</span>,<span class="number">2</span> | <span class="number">0</span>,<span class="number">3</span></div><div class="line">----+-----+-----+----</div><div class="line"><span class="number">1</span>,<span class="number">0</span> | <span class="number">1</span>,<span class="number">1</span> | <span class="number">1</span>,<span class="number">2</span> | <span class="number">1</span>,<span class="number">3</span></div><div class="line">----+-----+-----+----</div><div class="line"><span class="number">2</span>,<span class="number">0</span> | <span class="number">2</span>,<span class="number">1</span> | <span class="number">2</span>,<span class="number">2</span> | <span class="number">2</span>,<span class="number">3</span></div></pre></td></tr></table></figure>
<p>事实上计算机在内存中是这么存储的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>,<span class="number">0</span> | <span class="number">0</span>,<span class="number">1</span> | <span class="number">0</span>,<span class="number">2</span> | <span class="number">0</span>,<span class="number">3</span> | <span class="number">1</span>,<span class="number">0</span> | <span class="number">1</span>,<span class="number">1</span> | <span class="number">1</span>,<span class="number">2</span> | <span class="number">1</span>,<span class="number">3</span> | <span class="number">2</span>,<span class="number">0</span> | <span class="number">2</span>,<span class="number">1</span> | <span class="number">2</span>,<span class="number">2</span> | <span class="number">2</span>,<span class="number">3</span></div></pre></td></tr></table></figure>
<p><code>row()</code> 方法通过<strong>行</strong>，我们遍历整个数组是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">matrix[<span class="number">0</span>][<span class="number">0</span>] </div><div class="line">        matrix[<span class="number">0</span>][<span class="number">1</span>]</div><div class="line">                matrix[<span class="number">0</span>][<span class="number">2</span>]</div><div class="line">                        matrix[<span class="number">0</span>][<span class="number">3</span>]</div><div class="line">                                matrix[<span class="number">1</span>][<span class="number">0</span>] etc...</div></pre></td></tr></table></figure>
<p>这就意味着，我们是按照内存中的顺序有序读取 matrix 中的值，我们看看按照<strong>列</strong>读取的情形</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">matrix[<span class="number">0</span>][<span class="number">0</span>]</div><div class="line">matrix[<span class="number">1</span>][<span class="number">0</span>]</div><div class="line">matrix[<span class="number">2</span>][<span class="number">0</span>]</div><div class="line">matrix[<span class="number">3</span>][<span class="number">0</span>]</div><div class="line">matrix[<span class="number">4</span>][<span class="number">0</span>]</div></pre></td></tr></table></figure>
<p>内存中的数据每次是以小块儿(Cache Line)的形式传到 CPU 里面的，通常是 64 个字节。我们这里的数据是 4 个字节的 int 类型，也就是说 Cache Line 会一次性返回 16 个连续的整数。</p>
<p><code>row()</code> 方法</p>
<ol>
<li>Cache Line 返回 16 个 int 类型数据</li>
<li>修改<strong>所有</strong>这些数据</li>
<li>重复 (1024 <em> 256 </em> 16 * 32)/16 次</li>
</ol>
<p><code>col()</code> 方法</p>
<ol>
<li>Cache Line 返回 16 个 int 类型数据</li>
<li>修改<strong>其中</strong>一个值</li>
<li>重复 (1024 <em> 256 </em> 16 * 32) 次</li>
</ol>
<p>参考 stackoverflow 的几个链接</p>
<p><a href="http://stackoverflow.com/questions/3928995/how-do-cache-lines-work" target="_blank" rel="external">How do cache lines work?</a><br><a href="http://stackoverflow.com/questions/9888154/which-of-these-two-for-loops-is-more-efficient-in-terms-of-time-and-cache-perfor" target="_blank" rel="external">Which of these two for loops is more efficient in terms of time and cache performance</a><br><a href="http://stackoverflow.com/questions/9936132/why-does-the-order-of-the-loops-affect-performance-when-iterating-over-a-2d-arra" target="_blank" rel="external">Why does the order of the loops affect performance when iterating over a 2D array?</a></p>
<h1 id="JAVA-数组"><a href="#JAVA-数组" class="headerlink" title="JAVA 数组"></a>JAVA 数组</h1><p>数组在内存中是连续分配的，JAVA 中的数组是面向行存储的，即如果要读取某一列的数据，那么要跨越多个数据。</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/tmux基础/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">编辑器之 tmux&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>




<div class="share_addthis">
  <div class="sharing addthis_toolbox share">
    <a class="addthis_button_facebook_like"></a>
    <a class="addthis_button_tweet"></a>
    <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-560c64c35486b3d4" async="async"></script>
</div>





</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 yangsui&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>